<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<title>Portal Gun 3.1 Simulator</title>
<link rel="stylesheet" type="text/css" href="simstyle.css">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<h3>Portal Gun 3.1 Simulator</h3>

<div class="auto_margin">
Gordon's Gun:<br>
<table style="width:300px" align="center">
<tr id="gordon_title">
	<th>Portal</th>
	<th>Lights</th> 
	<th>Mode</th>
	<th>State</th>
</tr>
<tr>
	<td><div id="gordon_portal"></div></td>
	<td><div id="gordon_leds"></div></td> 
	<td><div id="gordon_mode"></div></td>
	<td><div id="gordon_state"></div></td>
</tr>
</table>
<div id="gordon_gun"> 
<input type="button" class="button" id="gordon_primary_fire" value="Primary (Button 1)" onclick="button(gordon,chell,100)"/><br>
<input type="button" class="button" id="gordon_alt_fire" value="Alt (Button 2)" onclick="button(gordon,chell,101)"/><br>
<input type="button" class="button" id="gordon_mode_toggle" value="Mode (Button 3)" onclick="button(gordon,chell,102)"/><br>
<input type="button" class="button" id="gordon_reset" value="Reset (Button 4)" onclick="button(gordon,chell,103)"/><br>
</div>
<div id="gordon_special"></div>
<br>
<br>
Chell's Gun:<br>
<table style="width:300px" align="center">
<tr id="chell_title">
<th>Portal</th>
<th>Lights</th> 
<th>Mode</th>
<th>State</th>
</tr>
<tr>
<td><div id="chell_portal"></div></td>
<td><div id="chell_leds"></div></td> 
<td><div id="chell_mode"></div></td>
<td><div id="chell_state"></div></td>
</tr>
</table>
<div id="chell_gun"> 
<input type="button" class="button" id="chell_primary_fire" value="Primary (Button 1)" onclick="button(chell,gordon,100)"/><br>
<input type="button" class="button" id="chell_alt_fire" value="Alt (Button 2)" onclick="button(chell,gordon,101)"/><br>
<input type="button" class="button" id="chell_mode_toggle" value="Mode (Button 3)" onclick="button(chell,gordon,102)"/><br>
<input type="button" class="button" id="chell_reset" value="Reset (Button 4)" onclick="button(chell,gordon,103)"/><br>
</div>
<div id="chell_special"></div>
</div>
<script>

var MODE_SOLO = 1;
var MODE_DUO = 2;


var gordon = {  'mode':  MODE_DUO, 'state_solo': 0 ,'state_duo': 0, 'state': 0,'initiator': false , 'state_previous': 0,  'special': false};
var chell = {  'mode':  MODE_DUO, 'state_solo': 0 ,'state_duo': 0, 'state': 0,'initiator': false, 'state_previous': 0,  'special': false };

update();

//state engine code copy/pasted out of C core logic
function button(this_gun,other_gun,button){


	this_gun.state_previous = this_gun.state_duo;

	//button event transitions
	if( button == 103){
		this_gun.initiator = false; //reset initiator
		this_gun.state_solo = 0; //reset self state
		this_gun.state_duo = 0; //reset local state
		this_gun.mode = MODE_DUO; //reset to duo mode for common use case
	}
	else if(button == 102){
		this_gun.initiator = false; //reset initiator
		if (this_gun.state_solo == 0 && this_gun.state_duo == 0){//only allow mode toggle when in mode zero
			if (this_gun.mode == MODE_DUO){
				this_gun.mode = MODE_SOLO;
			}else if (this_gun.mode == MODE_SOLO){
				this_gun.mode = MODE_DUO;
			}
		}
		
		//TODO: add code from V2: (button == BUTTON_BOTH_LONG_ORANGE){  and (button == BUTTON_BOTH_LONG_BLUE){
	}
	else if (button == 100){
		if (this_gun.mode == MODE_DUO){
			//projector modes
			if(this_gun.state_duo == 0){
				this_gun.state_duo = 1;
			}else if(this_gun.state_duo == 1){
				this_gun.state_duo = 2;
				this_gun.initiator = true; 
			}else if(this_gun.state_duo == 2 && this_gun.initiator == true){ //if leading the call, go through all modes
				this_gun.state_duo = 3;
			}else if(this_gun.state_duo == 2 && this_gun.initiator == false){  //answer an incoming call immediately and open portal on button press
				this_gun.state_duo = 4;  
			}else if(this_gun.state_duo == 5){ //open portal
				this_gun.state_duo = 4;
			}
			//camera modes
			else if (this_gun.state_duo == -1){
				this_gun.state_duo = -2;
				this_gun.initiator = true;
			}else if (this_gun.state_duo == -2 && this_gun.initiator == true){
				this_gun.state_duo = -3;
			}else if (this_gun.state_duo == -2 && this_gun.initiator == false){
				this_gun.state_duo = -4;
			}else if (this_gun.state_duo == -3 && this_gun.initiator == false){
				this_gun.state_duo = -4;  //connection established
			}
		}else if (this_gun.mode == MODE_SOLO){
			if(this_gun.state_solo >= 0 && this_gun.state_solo < 4){
				this_gun.state_solo++;
			}else if(this_gun.state_solo == 4){
				this_gun.state_solo = 3; //possibly move this to alt fire for consistency?  But then solo color change needs to be moved
			}else if(this_gun.state_solo < 0 && this_gun.state_solo > -4){
				this_gun.state_solo--;
			}else if(this_gun.state_solo == -4){
				this_gun.state_solo = -3; //possibly move this to alt fire for consistency? But then solo color change needs to be moved
			}		
		}
	}
	else if (button == 101){
		if (this_gun.mode == MODE_DUO){
			if(this_gun.state_duo == -4){ //quick swap function
				this_gun.state_duo = 4;
			}
			else if (this_gun.state_duo == 0){ //start duo camera mode
				this_gun.state_duo = -1;
			}else if(this_gun.state_duo == 4){ //go back to closed portal for effect change 
				this_gun.state_duo = 5;  //moved to alt fire from primary to prevent mode overrun when quickly tapping fire
			}
		}else if (this_gun.mode == MODE_SOLO){
			if(this_gun.state_solo == 0){ //blue solo portal open
				this_gun.state_solo = -1;
			}else if(this_gun.state_solo == 3 || this_gun.state_solo == 4){//solo portal color change
				this_gun.state_solo = -3;
			}else if(this_gun.state_solo == -3 || this_gun.state_solo == -4){//solo portal color change
				this_gun.state_solo = 3;
			}			
		}
	}
	
	if ( Math.abs(this_gun.state_duo) > 1)	this_gun.state = this_gun.state_duo;
	else this_gun.state = 0; 
	
	//let the other gun isntantly reply
	other_gun_transitions(other_gun,this_gun) ;

	
	update();
}


function other_gun_transitions(this_gun,other_gun){

	this_gun.state_previous = this_gun.state_duo;

	//other gun transitions
	if (this_gun.mode == MODE_DUO){
		if ((other_gun.state_previous >= 2 || other_gun.state_previous <= -2)  && other_gun.state == 0){
			this_gun.state_duo = 0;
		}
		if (other_gun.state_previous != -2 && other_gun.state == -2 && this_gun.initiator == false){
			this_gun.state_duo = 2;
		}
		if (other_gun.state_previous != 2 && other_gun.state == 2 && this_gun.initiator == false){
			this_gun.state_duo = -2;
		}
		if (other_gun.state_previous != 3 && other_gun.state == 3 && this_gun.initiator == false){
			this_gun.state_duo = -3;
		}
		if (other_gun.state_previous != -3 && other_gun.state == -3 && this_gun.initiator == false){
			this_gun.state_duo = 2;
		}	
		if (other_gun.state_previous != -4 && other_gun.state == -4 && this_gun.initiator == true){
			this_gun.state_duo = 4;
			this_gun.initiator = false;
		}
		if (other_gun.state_previous != 4 && other_gun.state == 4 && this_gun.initiator == true){
			this_gun.state_duo = -4;
			this_gun.initiator = false;
		}
		if (other_gun.state_previous == -4 && other_gun.state >= 4 ){
			this_gun.state_duo = -4;
			this_gun.initiator = false;
		}	
	}else{
		//code to pull out of self state
		if ((other_gun.state_previous != other_gun.state)&& (other_gun.state <= -2)){
			if (this_gun.state_solo <= -3 || this_gun.state_solo >= 3){
				this_gun.state_duo = 4;
			}else{
				this_gun.state_duo = 2;
			}
			this_gun.special = true;
			this_gun.mode = MODE_DUO;
			this_gun.state_solo = 0;
		}
	}
	
}

function update(){
	if (chell.mode == MODE_DUO){
		chell_mode.innerHTML = "Duo";
		chell_state.innerHTML = chell.state_duo;
	}else if (chell.mode == MODE_SOLO){
		chell_mode.innerHTML = "Solo";
		chell_state.innerHTML = chell.state_solo;
	}
	
	if (gordon.mode == MODE_DUO){
		gordon_mode.innerHTML = "Duo";
		gordon_state.innerHTML = gordon.state_duo;
	}else if (gordon.mode == MODE_SOLO){
		
		gordon_mode.innerHTML = "Solo";
		gordon_state.innerHTML = gordon.state_solo;
	}
	
	if (gordon.mode == MODE_DUO){
		if (gordon.state_duo == 5) gordon_portal.innerHTML = "Closed";  
		else if (gordon.state_duo == 4) gordon_portal.innerHTML = "Open";
		else if (gordon.state_duo == 3) gordon_portal.innerHTML = "Closed";
		else if (gordon.state_duo <= 2) gordon_portal.innerHTML = "Off";
		
		if (gordon.state_duo == 5) gordon_special.innerHTML = "Playlist Advance"; 
		else if (gordon.state_duo >= 4 && gordon.state_previous <= -4) gordon_special.innerHTML = "Swap To Projecting"; 
		else if (gordon.state_previous >= 4 && gordon.state_duo <= -4) gordon_special.innerHTML = "Swap To Camera"; 
		else if ((gordon.state_previous == 2 ||gordon.state_previous == 3 ||gordon.state_previous == 5)  && gordon.state_duo == 4) gordon_special.innerHTML = "Projector Going Live"; 
		else if ((gordon.state_previous == -2 ||gordon.state_previous == -3)  && gordon.state_duo == -4) gordon_special.innerHTML = "Camera Going Live"; 
		else gordon_special.innerHTML = "-"; 
		if (gordon.special) gordon_special.innerHTML = "Auto Solo to Duo";   gordon.special = false;
	}
	
	if (chell.mode == MODE_DUO){
		if (chell.state_duo == 5) chell_portal.innerHTML = "Closed";
		else if (chell.state_duo == 4) chell_portal.innerHTML = "Open";
		else if (chell.state_duo == 3) chell_portal.innerHTML = "Closed";
		else if (chell.state_duo <= 2) chell_portal.innerHTML = "Off";
		
		
		if (chell.state_duo == 5) chell_special.innerHTML = "Playlist Advance"; 
		else if (chell.state_duo >= 4 && chell.state_previous <= -4) chell_special.innerHTML = "Swap To Projecting"; 
		else if (chell.state_previous >= 4 && chell.state_duo <= -4) chell_special.innerHTML = "Swap To Camera"; 
		else if ((chell.state_previous == 2 ||chell.state_previous == 3||chell.state_previous == 5)  && chell.state_duo == 4) chell_special.innerHTML = "Projector Going Live"; 
		else if ((chell.state_previous == -2 ||chell.state_previous == -3)  && chell.state_duo == -4) chell_special.innerHTML = "Camera Going Live";
		else chell_special.innerHTML = "-"; 
		if (chell.special) chell_special.innerHTML = "Auto Solo to Duo";   chell.special = false;
		
	}
	
	if (Math.abs(gordon.state_duo) >= 3 || Math.abs(gordon.state_solo) >= 3 ) gordon_leds.innerHTML = "Full";
	else if (Math.abs(gordon.state_duo) > 0 || Math.abs(gordon.state_solo) > 0 ) gordon_leds.innerHTML = "Partial";
	else if (gordon.state_duo == 0 &&gordon.state_solo == 0 ) gordon_leds.innerHTML = "Off";

	if (Math.abs(chell.state_duo) >= 3 || Math.abs(chell.state_solo) >= 3) chell_leds.innerHTML = "Full";
	else if (Math.abs(chell.state_duo) > 0 || Math.abs(chell.state_solo) > 0 ) chell_leds.innerHTML = "Partial";
	else if (chell.state_duo == 0 &&chell.state_solo == 0) chell_leds.innerHTML = "Off";
	

	if (gordon.mode == MODE_SOLO){
		if (Math.abs(gordon.state_solo) == 4) gordon_portal.innerHTML = "Open";
		else if (Math.abs(gordon.state_solo) == 3) gordon_portal.innerHTML = "Closed";
		else if (Math.abs(gordon.state_solo) <= 2) gordon_portal.innerHTML = "Off";
	}
	if (chell.mode == MODE_SOLO){
		if (Math.abs(chell.state_solo) == 4) chell_portal.innerHTML = "Open";
		else if (Math.abs(chell.state_solo) == 3) chell_portal.innerHTML = "Closed";
		else if (Math.abs(chell.state_solo) <= 2) chell_portal.innerHTML = "Off";
	}

	if (gordon.state_duo  > 0 || gordon.state_solo > 0 ) gordon_title.style.color = "Orange"; 
	else if (gordon.state_duo < 0 || gordon.state_solo < 0 ) gordon_title.style.color = "Blue"; 
	else if (gordon.state_duo == 0 &&gordon.state_solo == 0 ) gordon_title.style.color = "White"; 

	if (chell.state_duo  > 0 || chell.state_solo > 0 ) chell_title.style.color = "Orange"; 
	else if (chell.state_duo < 0 || chell.state_solo < 0 ) chell_title.style.color = "Blue"; 
	else if (chell.state_duo == 0 &&chell.state_solo == 0 )	chell_title.style.color = "White"; 
	

}

</script>
</body>